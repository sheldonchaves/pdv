<div class="bg-background-light text-slate-900 font-display overflow-hidden h-screen flex flex-col">
  <!-- Header -->
  <header class="flex items-center justify-between whitespace-nowrap bg-brand-blue border-b border-white/10 px-6 py-3 shrink-0 text-white">
    <div class="flex items-center gap-6">
      <button 
        class="flex items-center justify-center rounded-lg size-10 bg-white/10 text-white hover:bg-white/20 transition-colors"
        (click)="toggleSidebar()"
        title="Minimizar/Maximizar Menu"
      >
        <i class="bi bi-list text-xl"></i>
      </button>
      <a routerLink="/" class="flex items-center gap-3 cursor-pointer">
        <div class="size-8 bg-brand-yellow rounded flex items-center justify-center text-brand-blue">
          <i class="bi bi-cash-register text-xl"></i>
        </div>
        <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em]">Millena PDV</h2>
      </a>
      <label class="flex flex-col flex-1 !h-10 min-w-0">
        <div class="flex w-full flex-1 items-stretch rounded-lg h-full overflow-hidden">
          <div class="text-slate-400 flex border-none bg-white items-center justify-center pl-4 shrink-0">
            <i class="bi bi-search text-xl text-brand-orange"></i>
          </div>
          <input 
            class="form-input flex w-full min-w-0 flex-1 border-none bg-white text-slate-900 focus:ring-0 h-full placeholder:text-slate-400 px-4 pl-2 text-base font-normal leading-normal" 
            placeholder="Buscar produtos, SKUs..."
            [value]="searchTerm()"
            (input)="onSearchChange($any($event.target).value)"
          />
          <button 
            class="text-slate-400 flex border-none bg-white items-center justify-center pr-4 hover:text-brand-orange transition-colors shrink-0"
            title="Escanear código de barras/QR Code"
            (click)="openBarcodeScanner()"
          >
            <i class="bi bi-upc-scan text-xl"></i>
          </button>
        </div>
      </label>
    </div>
    <div class="flex items-center gap-2 md:gap-4 shrink-0">
      <div class="flex items-center gap-2 md:gap-3">
        <div class="text-right hidden lg:block">
          <p class="text-[10px] uppercase tracking-wider text-brand-yellow font-bold leading-none">Vendedor Logado</p>
          <p class="text-sm font-semibold">{{ userService.currentUser().name }}</p>
        </div>
        <div 
          class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8 md:size-10 border-2 border-brand-yellow shrink-0" 
          [style.background-image]="'url(' + userService.currentUser().avatar + ')'"
        ></div>
      </div>
      <div class="flex gap-1 md:gap-2">
        <!-- Carrinho no Header -->
        <div class="relative">
          <button 
            class="flex items-center justify-center rounded-lg size-10 md:size-12 bg-white/10 text-white hover:bg-white/20 transition-colors shrink-0 relative"
            title="Carrinho"
            (click)="toggleCartDropdown()"
          >
            <i class="bi bi-cart text-brand-orange text-xl md:text-2xl"></i>
            @if (itemCount() > 0) {
              <span class="absolute -top-1 -right-1 bg-brand-orange text-white text-xs font-bold rounded-full size-6 flex items-center justify-center">{{ itemCount() }}</span>
            }
          </button>
          
          <!-- Dropdown do Carrinho -->
          @if (showCartDropdown()) {
            <div class="absolute top-full right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-slate-200 z-50 max-h-[600px] flex flex-col">
              <div class="p-4 border-b border-slate-200 flex items-center justify-between">
                <h3 class="text-brand-blue text-lg font-bold">Carrinho</h3>
                <button 
                  class="text-slate-400 hover:text-slate-600"
                  (click)="showCartDropdown.set(false)"
                >
                  <i class="bi bi-x-lg"></i>
                </button>
              </div>
              
              <div class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 max-h-[400px]">
                @if (cart().items.length === 0) {
                  <div class="flex flex-col items-center justify-center py-8 text-slate-400">
                    <i class="bi bi-cart text-4xl mb-2"></i>
                    <p class="text-sm font-medium">Carrinho vazio</p>
                  </div>
                } @else {
                  @for (item of cart().items; track item.product.id) {
                    <div class="flex gap-3 bg-slate-50 p-3 rounded-lg border border-slate-100">
                      <div 
                        class="size-16 rounded bg-cover bg-center shrink-0 cursor-pointer"
                        [style.background-image]="'url(' + item.product.images[0] + ')'"
                        (click)="goToProduct(item.product.id)"
                      ></div>
                      <div class="flex flex-col flex-1 min-w-0">
                        <p class="text-sm font-semibold truncate text-slate-900 cursor-pointer" (click)="goToProduct(item.product.id)">{{ item.product.name }}</p>
                        <p class="text-[10px] text-slate-500">SKU: {{ item.product.sku }}</p>
                        <div class="flex items-center justify-between mt-2">
                          <div class="flex items-center gap-2 bg-white border border-slate-200 rounded px-1">
                            <button class="text-slate-900 hover:text-brand-blue transition-colors" (click)="decreaseQuantity(item.product.id, item.quantity)">
                              <i class="bi bi-dash text-sm"></i>
                            </button>
                            <span class="text-sm font-bold w-4 text-center">{{ item.quantity }}</span>
                            <button class="text-slate-900 hover:text-brand-blue transition-colors" (click)="increaseQuantity(item.product.id, item.quantity)">
                              <i class="bi bi-plus text-sm"></i>
                            </button>
                          </div>
                          <p class="text-sm font-bold text-brand-blue">R$ {{ formatPrice(item.product.price * item.quantity) }}</p>
                        </div>
                      </div>
                      <button class="text-slate-300 hover:text-red-500 transition-colors shrink-0" (click)="removeItem(item.product.id)" title="Remover item">
                        <i class="bi bi-trash text-lg"></i>
                      </button>
                    </div>
                  }
                }
              </div>
              
              @if (cart().items.length > 0) {
                <div class="p-4 bg-slate-50 border-t border-slate-200 flex flex-col gap-3">
                  <!-- Cupom de Desconto -->
                  <div class="flex flex-col gap-2">
                    @if (cart().coupon) {
                      <div class="flex items-center justify-between p-2 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center gap-2">
                          <i class="bi bi-tag-fill text-green-600"></i>
                          <div class="flex flex-col">
                            <span class="text-xs font-bold text-green-700">{{ cart().coupon!.code }}</span>
                            @if (cart().coupon!.type === 'percent') {
                              <span class="text-[10px] text-green-600">{{ cart().coupon!.discountPercent }}% OFF</span>
                            } @else {
                              <span class="text-[10px] text-green-600">R$ {{ formatPrice(cart().coupon!.discount) }} OFF</span>
                            }
                          </div>
                        </div>
                        <button 
                          class="text-green-600 hover:text-green-800"
                          (click)="removeCoupon()"
                          title="Remover cupom"
                        >
                          <i class="bi bi-x-lg text-sm"></i>
                        </button>
                      </div>
                    } @else {
                      <div class="flex flex-col gap-2">
                        <div class="flex gap-2">
                          <input
                            type="text"
                            class="flex-1 px-3 py-2 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-brand-blue"
                            placeholder="Cupom de desconto"
                            [value]="couponCode()"
                            (input)="couponCode.set($any($event.target).value); couponError.set(''); couponSuccess.set('')"
                            (keyup.enter)="applyCoupon()"
                          />
                          <button
                            class="px-3 py-2 bg-brand-blue text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
                            (click)="applyCoupon()"
                          >
                            <i class="bi bi-check-lg"></i>
                          </button>
                        </div>
                        @if (couponError()) {
                          <p class="text-xs text-red-600 flex items-center gap-1">
                            <i class="bi bi-exclamation-circle"></i>
                            {{ couponError() }}
                          </p>
                        }
                        @if (couponSuccess()) {
                          <p class="text-xs text-green-600 flex items-center gap-1">
                            <i class="bi bi-check-circle"></i>
                            {{ couponSuccess() }}
                          </p>
                        }
                      </div>
                    }
                  </div>
                  
                  <!-- Resumo -->
                  <div class="flex flex-col gap-2 pt-2 border-t border-slate-200">
                    <div class="flex justify-between text-xs">
                      <span class="text-slate-500">Subtotal</span>
                      <span class="text-slate-700 font-medium">R$ {{ formatPrice(cart().subtotal) }}</span>
                    </div>
                    @if (cart().discount > 0) {
                      <div class="flex justify-between text-xs text-green-600">
                        <span>Desconto</span>
                        <span class="font-bold">- R$ {{ formatPrice(cart().discount) }}</span>
                      </div>
                    }
                    <div class="flex justify-between text-sm pt-1 border-t border-slate-200">
                      <span class="text-slate-700 font-bold">Total</span>
                      <span class="text-lg font-bold text-brand-blue">R$ {{ formatPrice(cart().total) }}</span>
                    </div>
                  </div>
                  
                  <button 
                    class="w-full bg-brand-yellow text-brand-blue font-bold py-3 rounded-lg flex items-center justify-center gap-2 hover:brightness-105 transition-all"
                    (click)="goToCheckout()"
                  >
                    Finalizar Pedido <i class="bi bi-arrow-right"></i>
                  </button>
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>
  </header>

  <!-- Popup de Escaneamento de Código de Barras -->
  @if (showBarcodeScanner()) {
    <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" (click)="closeBarcodeScanner()">
      <div class="bg-white rounded-xl p-8 max-w-md w-full shadow-2xl" (click)="$event.stopPropagation()">
        <div class="flex flex-col items-center gap-4">
          <div class="relative">
            <div class="w-64 h-64 border-4 border-brand-orange rounded-lg relative overflow-hidden">
              @if (scanningBarcode()) {
                <div class="absolute inset-0 bg-gradient-to-b from-transparent via-brand-orange/20 to-transparent animate-pulse"></div>
                <div class="absolute top-1/2 left-0 right-0 h-1 bg-brand-orange animate-bounce"></div>
              }
              <div class="absolute inset-0 flex items-center justify-center">
                <i class="bi bi-upc-scan text-6xl text-brand-orange"></i>
              </div>
            </div>
          </div>
          <div class="text-center">
            <h3 class="text-xl font-bold text-slate-900 mb-2">
              @if (scanningBarcode()) {
                Escaneando código...
              } @else {
                Código encontrado!
              }
            </h3>
            <p class="text-slate-600 text-sm">
              @if (scanningBarcode()) {
                Aponte a câmera para o código de barras
              } @else {
                Produto encontrado e adicionado à busca
              }
            </p>
          </div>
          <button 
            class="mt-4 px-6 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors"
            (click)="closeBarcodeScanner()"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>
  }

  <div class="flex flex-1 overflow-hidden min-w-0">
    <!-- Sidebar -->
    <aside 
      class="bg-brand-blue border-r border-white/10 flex flex-col shrink-0 overflow-y-auto no-scrollbar text-white transition-all duration-300"
      [class.w-64]="!sidebarMinimized()"
      [class.min-w-64]="!sidebarMinimized()"
      [class.max-w-64]="!sidebarMinimized()"
      [class.w-24]="sidebarMinimized()"
      [class.min-w-24]="sidebarMinimized()"
      [class.max-w-24]="sidebarMinimized()"
    >
      <div class="p-6">
        @if (!sidebarMinimized()) {
          <!-- <div class="flex flex-col mb-6">
            <h1 class="text-brand-yellow text-xs font-bold uppercase tracking-widest leading-normal">Categorias</h1>
            <p class="text-blue-100 text-sm font-normal leading-normal">Catálogo Geral</p>
          </div> -->
        }
        <nav class="flex flex-col gap-2">
          @for (category of categories(); track category.id) {
            <div 
              class="flex items-center gap-3 rounded-lg cursor-pointer transition-colors relative group"
              [class.bg-brand-yellow]="selectedCategory() === category.id"
              [class.text-brand-blue]="selectedCategory() === category.id"
              [class.shadow-md]="selectedCategory() === category.id"
              [class.hover:bg-white/10]="selectedCategory() !== category.id"
              [class.text-white]="selectedCategory() !== category.id"
              [class.justify-center]="sidebarMinimized()"
              [class.px-6]="sidebarMinimized()"
              [class.py-4]="sidebarMinimized()"
              [class.px-4]="!sidebarMinimized()"
              [class.py-3]="!sidebarMinimized()"
              (click)="onCategorySelect(category.id)"
              [title]="sidebarMinimized() ? category.name : ''"
            >
              <i 
                class="bi bi-{{ category.icon }} text-3xl md:text-4xl"
                [class.text-brand-orange]="selectedCategory() !== category.id && !sidebarMinimized()"
              ></i>
              @if (!sidebarMinimized()) {
                <p class="text-sm" [class.font-bold]="selectedCategory() === category.id" [class.font-medium]="selectedCategory() !== category.id">{{ category.name }}</p>
              }
            </div>
          }
        </nav>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 bg-background-light overflow-y-auto flex flex-col min-w-0">
      <router-outlet></router-outlet>
    </main>
  </div>
</div>
